---
# Playbook: Regenerate SSH Host Keys
# Only generates keys if they don't already exist
# Usage: ansible-playbook playbooks/ssh-hostkeys.yml

- name: Regenerate SSH Host Keys
  hosts: raspberry_pis
  become: true

  tasks:
    - name: Check if SSH host keys exist
      ansible.builtin.stat:
        path: /etc/ssh/ssh_host_ed25519_key
      register: ssh_key_check

    - name: Generate SSH host keys if missing
      when: not ssh_key_check.stat.exists
      block:
        - name: Regenerate SSH host keys
          ansible.builtin.command: dpkg-reconfigure openssh-server
          changed_when: true
          notify: Restart SSH

        - name: Display notice about known_hosts
          ansible.builtin.debug:
            msg: >
              SSH host keys have been generated. You may need to update
              your ~/.ssh/known_hosts file on your local machine.
              Run: ssh-keygen -R {{ ansible_host }}

    - name: SSH keys already exist
      ansible.builtin.debug:
        msg: "SSH host keys already exist, skipping regeneration"
      when: ssh_key_check.stat.exists

  handlers:
    - name: Restart SSH
      ansible.builtin.systemd:
        name: ssh
        state: restarted