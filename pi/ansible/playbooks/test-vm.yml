---
# Playbook: Test VM with Pi Configuration
# Runs the full setup on test-vm using either pi1 or pi2 configuration
#
# Usage:
#   Test with Pi1 config: ansible-playbook playbooks/test-vm.yml -e "test_config=pi1"
#   Test with Pi2 config: ansible-playbook playbooks/test-vm.yml -e "test_config=pi2"

- name: Validate test configuration
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Check test_config is provided
      ansible.builtin.fail:
        msg: |
          You must specify which configuration to test.
          Usage:
            ansible-playbook playbooks/test-vm.yml -e "test_config=pi1"
            ansible-playbook playbooks/test-vm.yml -e "test_config=pi2"
      when: test_config is not defined

    - name: Validate test_config value
      ansible.builtin.fail:
        msg: "test_config must be 'pi1' or 'pi2', got: {{ test_config }}"
      when: test_config not in ['pi1', 'pi2']

    - name: Display test configuration
      ansible.builtin.debug:
        msg: "Testing VM with {{ test_config }} configuration"

- name: Load and apply configuration to test VM
  hosts: test-vm
  gather_facts: true
  become: true

  pre_tasks:
    - name: Load pi1 configuration
      ansible.builtin.include_vars:
        file: "../group_vars/pi1_config.yml"
      when: test_config == "pi1"

    - name: Load pi2 configuration
      ansible.builtin.include_vars:
        file: "../group_vars/pi2_config.yml"
      when: test_config == "pi2"

    - name: Display active configuration
      ansible.builtin.debug:
        msg: |
          Testing {{ inventory_hostname }} with {{ test_config }} configuration
          Hostname: {{ custom_hostname | default('not set') }}
          WiFi MAC Override: {{ wifi_mac_override | default('not set') }}
          Is VM: {{ is_vm | default(false) }}

- name: Run boot configuration
  ansible.builtin.import_playbook: boot-config.yml
  vars:
    target_hosts: test-vm

- name: Run network setup
  ansible.builtin.import_playbook: network-setup.yml
  vars:
    target_hosts: test-vm

- name: Run hostname configuration
  ansible.builtin.import_playbook: hostname.yml
  vars:
    target_hosts: test-vm

- name: Run WiFi MAC override
  ansible.builtin.import_playbook: wifi-mac-override.yml
  vars:
    target_hosts: test-vm

- name: Run SSH host keys regeneration
  ansible.builtin.import_playbook: ssh-hostkeys.yml
  vars:
    target_hosts: test-vm

- name: Run disable sleep
  ansible.builtin.import_playbook: disable-sleep.yml
  vars:
    target_hosts: test-vm

- name: Run Docker installation
  ansible.builtin.import_playbook: docker-install.yml
  vars:
    target_hosts: test-vm

- name: Test complete
  hosts: test-vm
  tasks:
    - name: Display test completion
      ansible.builtin.debug:
        msg: |
          âœ“ Test VM setup complete with {{ test_config }} configuration!
          
          Configuration applied:
          - Hostname: {{ custom_hostname | default('not set') }}.local
          - WiFi MAC Override: {{ wifi_mac_override | default('not set') }}
          - Hardware tasks: {{ 'skipped (VM)' if is_vm | default(false) else 'applied' }}
