services:
  cyberdeck-login-server:
    build: .
    container_name: cyberdeck-login-server
    restart: unless-stopped
    
    # Required for Bluetooth access (native mode only)
    privileged: true
    network_mode: host
    
    volumes:
      # Configuration and public keys
      - ./data:/data
      
      # D-Bus access for lock screen monitoring
      - /var/run/dbus:/var/run/dbus
      
      # Bluetooth device access (native mode)
      - /dev:/dev
      
      # X11 access for idle detection (optional)
      - /tmp/.X11-unix:/tmp/.X11-unix
      
      # PAM trigger file location
      - /tmp:/tmp
    
    environment:
      - NODE_ENV=production
      - CONFIG_PATH=/data/config.json
      - PUBLIC_KEYS_DIR=/data/publicKeys
      - COMPUTER_NAME=${COMPUTER_NAME:-cyberdeck}
      - LOGIN_USER=${LOGIN_USER:-pi}
      - BLE_MODE=${BLE_MODE:-native}
      - TCP_PORT=${TCP_PORT:-3100}
      - DISPLAY=${DISPLAY:-:0}
      - DBUS_SESSION_BUS_ADDRESS=${DBUS_SESSION_BUS_ADDRESS}
      - CONTAINER_MODE=true
    
    # Use host's D-Bus session
    pid: host
    
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"